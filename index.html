import torch
from transformers import AutoTokenizer, AutoModelForCausalLM
import json
import threading
import time
import requests
from datetime import datetime
from flask import Flask, request, jsonify
from flask_cors import CORS

model_id = "Sadou/medgemma-4b-it-french-medical-assistant"
model = AutoModelForCausalLM.from_pretrained(model_id, torch_dtype=torch.bfloat16)
tokenizer = AutoTokenizer.from_pretrained(model_id)

if tokenizer.pad_token is None:
    tokenizer.pad_token = tokenizer.eos_token

# Removed MQTT configuration - only using Flask API

# Flask app setup
app = Flask(__name__)
CORS(app)

APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzp2CdAXSXMG6BB_bypmG_NRusA-G4mfUgMdP9nlYa8pGofm5PeFzQeRt4Undv6Wco5_A/exec"  

def send_to_google_sheets(data, ai_response):
    try:
        payload = {
            "id": str(data.get("ID", "N/A")),
            "aiResponse": ai_response.replace("\n", " ").replace('"', "'"),
            "type": "ai_consultation"
        }
        
        print(f"üîÑ ƒêang g·ª≠i AI response cho ID {payload['id']}...")
        
        response = requests.post(APPS_SCRIPT_URL, 
                               headers={'Content-Type': 'application/x-www-form-urlencoded'},
                               data=payload, 
                               timeout=15)
        
        if response.status_code == 200:
            try:
                result = response.json()
                if result.get("status") == "success":
                    print(f"‚úÖ ƒê√£ c·∫≠p nh·∫≠t AI response l√™n Google Sheets: ID {data.get('ID')}")
                    print(f"üìù V·ªã tr√≠: {result.get('message', 'Th√†nh c√¥ng')}")
                    return True
                else:
                    print(f"‚ùå Apps Script error: {result.get('message', 'Unknown error')}")
                    return False
            except json.JSONDecodeError:
                # N·∫øu response kh√¥ng ph·∫£i JSON, ki·ªÉm tra text response
                if "Success" in response.text or "success" in response.text:
                    print(f"‚úÖ ƒê√£ g·ª≠i AI response l√™n Google Sheets: ID {data.get('ID')}")
                    return True
                else:
                    print(f"‚ö†Ô∏è Response kh√¥ng ph·∫£i JSON: {response.text[:200]}")
                    return False
        else:
            print(f"‚ùå HTTP Error: {response.status_code}")
            print(f"Response: {response.text[:200]}")
            return False
            
    except requests.exceptions.Timeout:
        print("‚ùå Timeout khi g·ª≠i d·ªØ li·ªáu l√™n Google Sheets")
        return False
    except requests.exceptions.RequestException as e:
        print(f"‚ùå L·ªói k·∫øt n·ªëi: {e}")
        return False
    except Exception as e:
        print(f"‚ùå L·ªói khi g·ª≠i d·ªØ li·ªáu l√™n Google Sheets: {e}")
        return False

# Flask API endpoint for web consultation
@app.route('/health-consultation', methods=['POST'])
def health_consultation():
    try:
        data = request.get_json()
        print(f"üì® Nh·∫≠n y√™u c·∫ßu t∆∞ v·∫•n t·ª´ web: {data}")
        
        # Validate required fields
        required_fields = ["id", "heartRate", "breathRate", "weight", "height"]
        for field in required_fields:
            if field not in data:
                return jsonify({
                    "status": "error", 
                    "message": f"Thi·∫øu th√¥ng tin: {field}"
                }), 400
        
        # Convert data format to match MQTT format
        health_data = {
            "ID": data["id"],
            "HeartRate": int(data["heartRate"]),
            "BreathRate": int(data["breathRate"]),
            "Weight": float(data["weight"]),
            "Height": float(data["height"]),
            "Gender": data.get("gender", ""),
            "Age": data.get("age", "")
        }
        
        # Calculate BMI if not provided
        if "bmi" in data and data["bmi"]:
            health_data["BMI"] = float(data["bmi"])
        else:
            height_m = health_data["Height"] / 100
            health_data["BMI"] = round(health_data["Weight"] / (height_m ** 2), 1)
        
        # Process health consultation
        ai_response = get_ai_consultation(health_data)
        
        # Send to Google Sheets
        sheets_success = send_to_google_sheets(health_data, ai_response)
        
        return jsonify({
            "status": "success",
            "aiResponse": ai_response,
            "sheetsSaved": sheets_success,
            "message": "T∆∞ v·∫•n s·ª©c kh·ªèe th√†nh c√¥ng!"
        })
        
    except Exception as e:
        print(f"‚ùå L·ªói API health-consultation: {e}")
        return jsonify({
            "status": "error",
            "message": f"L·ªói x·ª≠ l√Ω: {str(e)}"
        }), 500

# Health check endpoint
@app.route('/', methods=['GET'])
def health_check():
    return jsonify({
        "status": "ok",
        "service": "Medical AI",
        "message": "Server ƒëang ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng",
        "endpoints": {
            "consultation": "/health-consultation (POST)",
            "health": "/ (GET)"
        }
    })

def get_ai_consultation(data):
    """Generate AI health consultation"""
    try:
        heart_rate = data["HeartRate"]
        breathing_rate = data["BreathRate"]
        weight = data["Weight"]
        height = data["Height"]
        bmi = data["BMI"]
        
        # Create enhanced question with gender and age if available
        base_question = (f"Nh·ªãp tim c·ªßa t√¥i l√† {heart_rate}bpm, nh·ªãp th·ªü l√† {breathing_rate}rpm, "
                        f"c√¢n n·∫∑ng l√† {weight}kg, chi·ªÅu cao l√† {height}cm, BMI l√† {bmi}")
        
        if data.get("Age"):
            base_question += f", tu·ªïi {data['Age']}"
        if data.get("Gender"):
            base_question += f", gi·ªõi t√≠nh {data['Gender']}"
            
        base_question += ". H√£y t∆∞ v·∫•n cho t√¥i v·ªÅ s·ª©c kh·ªèe hi·ªán t·∫°i. C·∫ßn chi ti·∫øt v·ªÅ t√¨nh tr·∫°ng s·ª©c kh·ªèe, l·ªùi khuy√™n v·ªÅ ƒÉn u·ªëng v√† l·ªëi s·ªëng."
        
        messages = [
            {"role": "system", "content": "B·∫°n l√† m·ªôt tr·ª£ l√Ω y t·∫ø chuy√™n nghi·ªáp. H√£y lu√¥n tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát v·ªõi l·ªùi khuy√™n y t·∫ø r√µ r√†ng v√† ch√≠nh x√°c."},
            {"role": "user", "content": base_question}
        ]

        inputs = tokenizer.apply_chat_template(messages, add_generation_prompt=True, return_tensors="pt")
        attention_mask = inputs != tokenizer.pad_token_id

        outputs = model.generate(
            inputs, 
            attention_mask=attention_mask,
            max_new_tokens=300, 
            temperature=0.7,
            pad_token_id=tokenizer.eos_token_id,
            do_sample=True
        )

        response = tokenizer.decode(outputs[0][inputs.shape[-1]:], skip_special_tokens=True)
        
        print("\n" + "="*50)
        print(f"ü©∫ K·∫øt qu·∫£ t∆∞ v·∫•n cho ID {data.get('ID', 'N/A')}:")
        print(f"üìä Th√¥ng s·ªë: Nh·ªãp tim {heart_rate}bpm | Nh·ªãp th·ªü {breathing_rate}rpm | BMI {bmi}")
        print("="*50)
        print(response)
        print("="*50 + "\n")
        
        return response
        
    except Exception as e:
        print(f"‚ùå L·ªói t·∫°o AI consultation: {e}")
        return "Xin l·ªói, kh√¥ng th·ªÉ t·∫°o t∆∞ v·∫•n s·ª©c kh·ªèe l√∫c n√†y. Vui l√≤ng th·ª≠ l·∫°i sau."

def main():
    print("ƒêang kh·ªüi ƒë·ªông Medical AI Flask API...")
    
    if "YOUR_DEPLOYMENT_ID" in APPS_SCRIPT_URL:
        print("‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh Apps Script URL!")
        print("üí° Vui l√≤ng thay YOUR_DEPLOYMENT_ID b·∫±ng deployment ID th·ª±c t·∫ø")
    
    try:
        print("üåê ƒêang kh·ªüi ƒë·ªông Flask API server...")
        print("‚úÖ Medical AI API ƒë√£ s·∫µn s√†ng!")
        print("üåê Flask API: http://localhost:5000/health-consultation")
        print("Nh·∫•n Ctrl+C ƒë·ªÉ tho√°t")
        
        # Start Flask API
        app.run(host='0.0.0.0', port=5000, debug=False, threaded=True)
            
    except KeyboardInterrupt:
        print("\nƒêang tho√°t...")
    except Exception as e:
        print(f"L·ªói: {e}")
    finally:
        print("ƒê√£ t·∫Øt Medical AI API")

if __name__ == "__main__":
    main()
