<script>
// Thay Ä‘á»•i URL Google Apps Script náº¿u cáº§n
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxbDPVKFVNoabzN7eL_bO4q9TaQr3kdlP9EkjbRBfBEk-SOwkLE5EmPSENxKt8PNqYvdg/exec';

// Cáº¥u hÃ¬nh MQTT
const MQTT_BROKER = 'mqtt.fuvitech.vn';
const MQTT_PORT = 2883;
const MQTT_TOPIC = 'DATN/VALUESENSOR';
const MQTT_CLIENT_ID = 'web_client_' + Math.random().toString(16).slice(3);

// Khá»Ÿi táº¡o MQTT client
let client = null;

// Káº¿t ná»‘i MQTT khi trang táº£i
function connectMQTT() {
    client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, MQTT_CLIENT_ID);
    
    client.onConnectionLost = (responseObject) => {
        if (responseObject.errorCode !== 0) {
            console.error('MQTT Connection Lost:', responseObject.errorMessage);
            showStatus('error', 'âŒ Máº¥t káº¿t ná»‘i MQTT: ' + responseObject.errorMessage);
        }
    };

    client.onMessageArrived = (message) => {
        console.log('MQTT Message Received:', message.payloadString);
    };

    client.connect({
        onSuccess: () => {
            console.log('Connected to MQTT broker');
            showStatus('success', 'âœ… Káº¿t ná»‘i MQTT thÃ nh cÃ´ng');
            setTimeout(hideStatus, 3000);
        },
        onFailure: (error) => {
            console.error('MQTT Connection Failed:', error);
            showStatus('error', 'âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i MQTT: ' + error.errorMessage);
        },
        useSSL: true,
        // userName: 'your_username', // ThÃªm náº¿u cáº§n
        // password: 'your_password', // ThÃªm náº¿u cáº§n
        timeout: 10
    });
}

// Gá»i káº¿t ná»‘i MQTT khi trang táº£i
window.onload = () => {
    connectMQTT();
};

// Form submission (giá»¯ nguyÃªn tá»« mÃ£ gá»‘c)
document.getElementById('healthForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const status = document.getElementById('status');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'â³ Äang lÆ°u...';
    showStatus('loading', 'Äang lÆ°u thÃ´ng tin cÃ¡ nhÃ¢n...');
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    if (!data.id || !data.weight || !data.height || !data.age || !data.gender) {
        showStatus('error', 'âŒ Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin báº¯t buá»™c');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ’¾ LÆ°u thÃ´ng tin cÃ¡ nhÃ¢n';
        return;
    }
    
    const weight = parseFloat(data.weight);
    const height = parseFloat(data.height) / 100;
    
    if (isNaN(weight) || isNaN(height) || weight <= 0 || height <= 0) {
        showStatus('error', 'âŒ CÃ¢n náº·ng vÃ  chiá»u cao khÃ´ng há»£p lá»‡');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ’¾ LÆ°u thÃ´ng tin cÃ¡ nhÃ¢n';
        return;
    }
    
    const bmi = (weight / (height * height)).toFixed(2);
    data.bmi = bmi;
    data.type = 'personal_info';
    
    console.log('Sending data:', data);
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(data),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const result = await response.text();
        if (response.ok) {
            showStatus('success', `âœ… LÆ°u thÃ nh cÃ´ng thÃ´ng tin cho ID: ${data.id}! BMI: ${bmi}`);
            this.reset();
            setTimeout(() => hideStatus(), 5000);
        } else {
            throw new Error(`HTTP ${response.status}: ${result}`);
        }
    } catch (error) {
        console.error('Error:', error);
        showStatus('error', 'âŒ Lá»—i: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ’¾ LÆ°u thÃ´ng tin cÃ¡ nhÃ¢n';
    }
});

// Search functionality (giá»¯ nguyÃªn tá»« mÃ£ gá»‘c)
document.getElementById('searchBtn').addEventListener('click', async function() {
    const searchId = document.getElementById('searchId').value.trim();
    const searchBtn = document.getElementById('searchBtn');
    const searchResult = document.getElementById('searchResult');
    
    if (!searchId) {
        showStatus('error', 'âŒ Vui lÃ²ng nháº­p ID cáº§n tra cá»©u');
        return;
    }
    
    searchBtn.disabled = true;
    searchBtn.textContent = 'â³ Äang tÃ¬m kiáº¿m...';
    showStatus('loading', 'Äang tra cá»©u thÃ´ng tin...');
    
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL + '?action=search&id=' + encodeURIComponent(searchId));
        const result = await response.text();
        
        if (result.includes('not found') || result.includes('No data')) {
            showStatus('error', `âŒ KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u cho ID: ${searchId}`);
            searchResult.style.display = 'none';
            document.getElementById('consultBtn').style.display = 'none';
        } else {
            let data;
            try {
                data = JSON.parse(result);
            } catch (e) {
                showStatus('error', 'âŒ Dá»¯ liá»‡u khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng');
                return;
            }
            
            document.getElementById('resultId').textContent = searchId;
            document.getElementById('heartRate').textContent = data.heartRate ? data.heartRate + ' bpm' : '-- bpm';
            document.getElementById('breathRate').textContent = data.breathRate ? data.breathRate + ' rpm' : '-- rpm';
            document.getElementById('displayHeight').textContent = data.height ? data.height + ' cm' : '-- cm';
            document.getElementById('displayWeight').textContent = data.weight ? data.weight + ' kg' : '-- kg';
            document.getElementById('displayGender').textContent = data.gender || '--';
            document.getElementById('displayAge').textContent = data.age ? data.age + ' tuá»•i' : '-- tuá»•i';
            document.getElementById('displayBMI').textContent = data.bmi || '--';
            
            searchResult.style.display = 'block';
            showStatus('success', `âœ… TÃ¬m tháº¥y thÃ´ng tin cho ID: ${searchId}`);
            document.getElementById('consultBtn').style.display = 'block';
            setTimeout(() => hideStatus(), 3000);
        }
    } catch (error) {
        showStatus('error', 'âŒ Lá»—i khi tra cá»©u: ' + error.message);
        searchResult.style.display = 'none';
        document.getElementById('consultBtn').style.display = 'none';
    } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = 'ğŸ” Tra cá»©u thÃ´ng tin';
    }
});

// Health consultation functionality with MQTT
document.getElementById('consultBtn').addEventListener('click', function() {
    const consultBtn = document.getElementById('consultBtn');
    const resultId = document.getElementById('resultId').textContent;
    
    if (!resultId) {
        showStatus('error', 'âŒ KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ tÆ° váº¥n');
        return;
    }
    
    consultBtn.disabled = true;
    consultBtn.textContent = 'â³ Äang gá»­i dá»¯ liá»‡u tÆ° váº¥n...';
    showStatus('loading', 'Äang gá»­i dá»¯ liá»‡u tÆ° váº¥n sá»©c khá»e...');
    
    // Collect health data without type and timestamp
    const healthData = {
        id: resultId,
        heartRate: parseInt(document.getElementById('heartRate').textContent.replace(' bpm', '').replace('--', '') || '0'),
        breathRate: parseInt(document.getElementById('breathRate').textContent.replace(' rpm', '').replace('--', '') || '0'),
        height: parseFloat(document.getElementById('displayHeight').textContent.replace(' cm', '').replace('--', '') || '0'),
        weight: parseFloat(document.getElementById('displayWeight').textContent.replace(' kg', '').replace('--', '') || '0'),
        gender: document.getElementById('displayGender').textContent.replace('--', '') || '',
        age: parseInt(document.getElementById('displayAge').textContent.replace(' tuá»•i', '').replace('--', '') || '0'),
        bmi: parseFloat(document.getElementById('displayBMI').textContent.replace('--', '') || '0')
    };
    
    // Validate data
    if (!healthData.heartRate || !healthData.breathRate || !healthData.height || 
        !healthData.weight || !healthData.gender || !healthData.age || !healthData.bmi) {
        showStatus('error', 'âŒ Dá»¯ liá»‡u khÃ´ng Ä‘áº§y Ä‘á»§ Ä‘á»ƒ tÆ° váº¥n');
        console.error('Invalid data:', healthData);
        consultBtn.disabled = false;
        consultBtn.textContent = 'ğŸ©º TÆ° váº¥n sá»©c khá»e';
        return;
    }
    
    // Convert to JSON
    const payload = JSON.stringify(healthData);
    console.log('MQTT Payload:', payload);
    
    // Send to MQTT
    if (client && client.isConnected()) {
        try {
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = MQTT_TOPIC;
            client.send(message);
            console.log('MQTT Message Sent:', payload);
            showStatus('success', `âœ… ÄÃ£ gá»­i dá»¯ liá»‡u tÆ° váº¥n cho ID: ${resultId} qua MQTT`);
            setTimeout(() => hideStatus(), 5000);
        } catch (error) {
            console.error('MQTT Send Error:', error);
            showStatus('error', 'âŒ Lá»—i khi gá»­i dá»¯ liá»‡u MQTT: ' + error.message);
        }
    } else {
        console.error('MQTT Client not connected');
        showStatus('error', 'âŒ KhÃ´ng cÃ³ káº¿t ná»‘i MQTT. Vui lÃ²ng kiá»ƒm tra láº¡i.');
    }
    
    // Gá»­i dá»¯ liá»‡u Ä‘áº¿n Google Apps Script vá»›i type
    const scriptData = {
        ...healthData,
        type: 'health_consultation'
    };
    
    fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(scriptData)
    })
    .then(response => response.text())
    .then(result => {
        console.log('Google Script Response:', result);
    })
    .catch(error => {
        console.error('Google Script Error:', error);
    })
    .finally(() => {
        consultBtn.disabled = false;
        consultBtn.textContent = 'ğŸ©º TÆ° váº¥n sá»©c khá»e';
    });
});

// Allow Enter key to trigger search
document.getElementById('searchId').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('searchBtn').click();
    }
});

function showStatus(type, message) {
    const status = document.getElementById('status');
    status.className = `status ${type}`;
    status.textContent = message;
    status.style.display = 'block';
}

function hideStatus() {
    const status = document.getElementById('status');
    status.style.display = 'none';
}

// Auto-calculate and show BMI preview
document.getElementById('weight').addEventListener('input', updateBMIPreview);
document.getElementById('height').addEventListener('input', updateBMIPreview);

function updateBMIPreview() {
    const weight = parseFloat(document.getElementById('weight').value);
    const height = parseFloat(document.getElementById('height').value);
    
    if (weight > 0 && height > 0) {
        const bmi = (weight / Math.pow(height / 100, 2)).toFixed(1);
        let category = '';
        
        if (bmi < 18.5) category = '(Thiáº¿u cÃ¢n)';
        else if (bmi < 25) category = '(BÃ¬nh thÆ°á»ng)';
        else if (bmi < 30) category = '(Thá»«a cÃ¢n)';
        else category = '(BÃ©o phÃ¬)';
        
        document.getElementById('submitBtn').textContent = `ğŸ’¾ LÆ°u thÃ´ng tin (BMI: ${bmi} ${category})`;
    } else {
        document.getElementById('submitBtn').textContent = 'ğŸ’¾ LÆ°u thÃ´ng tin cÃ¡ nhÃ¢n';
    }
}
</script>
