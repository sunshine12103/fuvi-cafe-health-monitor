<script>
// Thay đổi URL Google Apps Script nếu cần
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxbDPVKFVNoabzN7eL_bO4q9TaQr3kdlP9EkjbRBfBEk-SOwkLE5EmPSENxKt8PNqYvdg/exec';

// Cấu hình MQTT
const MQTT_BROKER = 'mqtt.fuvitech.vn';
const MQTT_PORT = 2883;
const MQTT_TOPIC = 'DATN/VALUESENSOR';
const MQTT_CLIENT_ID = 'web_client_' + Math.random().toString(16).slice(3);

// Khởi tạo MQTT client
let client = null;

// Kết nối MQTT khi trang tải
function connectMQTT() {
    client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, MQTT_CLIENT_ID);
    
    client.onConnectionLost = (responseObject) => {
        if (responseObject.errorCode !== 0) {
            console.error('MQTT Connection Lost:', responseObject.errorMessage);
            showStatus('error', '❌ Mất kết nối MQTT: ' + responseObject.errorMessage);
        }
    };

    client.onMessageArrived = (message) => {
        console.log('MQTT Message Received:', message.payloadString);
    };

    client.connect({
        onSuccess: () => {
            console.log('Connected to MQTT broker');
            showStatus('success', '✅ Kết nối MQTT thành công');
            setTimeout(hideStatus, 3000);
        },
        onFailure: (error) => {
            console.error('MQTT Connection Failed:', error);
            showStatus('error', '❌ Không thể kết nối MQTT: ' + error.errorMessage);
        },
        useSSL: true,
        // userName: 'your_username', // Thêm nếu cần
        // password: 'your_password', // Thêm nếu cần
        timeout: 10
    });
}

// Gọi kết nối MQTT khi trang tải
window.onload = () => {
    connectMQTT();
};

// Form submission (giữ nguyên từ mã gốc)
document.getElementById('healthForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const status = document.getElementById('status');
    
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Đang lưu...';
    showStatus('loading', 'Đang lưu thông tin cá nhân...');
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    if (!data.id || !data.weight || !data.height || !data.age || !data.gender) {
        showStatus('error', '❌ Vui lòng điền đầy đủ thông tin bắt buộc');
        submitBtn.disabled = false;
        submitBtn.textContent = '💾 Lưu thông tin cá nhân';
        return;
    }
    
    const weight = parseFloat(data.weight);
    const height = parseFloat(data.height) / 100;
    
    if (isNaN(weight) || isNaN(height) || weight <= 0 || height <= 0) {
        showStatus('error', '❌ Cân nặng và chiều cao không hợp lệ');
        submitBtn.disabled = false;
        submitBtn.textContent = '💾 Lưu thông tin cá nhân';
        return;
    }
    
    const bmi = (weight / (height * height)).toFixed(2);
    data.bmi = bmi;
    data.type = 'personal_info';
    
    console.log('Sending data:', data);
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(data),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const result = await response.text();
        if (response.ok) {
            showStatus('success', `✅ Lưu thành công thông tin cho ID: ${data.id}! BMI: ${bmi}`);
            this.reset();
            setTimeout(() => hideStatus(), 5000);
        } else {
            throw new Error(`HTTP ${response.status}: ${result}`);
        }
    } catch (error) {
        console.error('Error:', error);
        showStatus('error', '❌ Lỗi: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '💾 Lưu thông tin cá nhân';
    }
});

// Search functionality (giữ nguyên từ mã gốc)
document.getElementById('searchBtn').addEventListener('click', async function() {
    const searchId = document.getElementById('searchId').value.trim();
    const searchBtn = document.getElementById('searchBtn');
    const searchResult = document.getElementById('searchResult');
    
    if (!searchId) {
        showStatus('error', '❌ Vui lòng nhập ID cần tra cứu');
        return;
    }
    
    searchBtn.disabled = true;
    searchBtn.textContent = '⏳ Đang tìm kiếm...';
    showStatus('loading', 'Đang tra cứu thông tin...');
    
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL + '?action=search&id=' + encodeURIComponent(searchId));
        const result = await response.text();
        
        if (result.includes('not found') || result.includes('No data')) {
            showStatus('error', `❌ Không tìm thấy dữ liệu cho ID: ${searchId}`);
            searchResult.style.display = 'none';
            document.getElementById('consultBtn').style.display = 'none';
        } else {
            let data;
            try {
                data = JSON.parse(result);
            } catch (e) {
                showStatus('error', '❌ Dữ liệu không đúng định dạng');
                return;
            }
            
            document.getElementById('resultId').textContent = searchId;
            document.getElementById('heartRate').textContent = data.heartRate ? data.heartRate + ' bpm' : '-- bpm';
            document.getElementById('breathRate').textContent = data.breathRate ? data.breathRate + ' rpm' : '-- rpm';
            document.getElementById('displayHeight').textContent = data.height ? data.height + ' cm' : '-- cm';
            document.getElementById('displayWeight').textContent = data.weight ? data.weight + ' kg' : '-- kg';
            document.getElementById('displayGender').textContent = data.gender || '--';
            document.getElementById('displayAge').textContent = data.age ? data.age + ' tuổi' : '-- tuổi';
            document.getElementById('displayBMI').textContent = data.bmi || '--';
            
            searchResult.style.display = 'block';
            showStatus('success', `✅ Tìm thấy thông tin cho ID: ${searchId}`);
            document.getElementById('consultBtn').style.display = 'block';
            setTimeout(() => hideStatus(), 3000);
        }
    } catch (error) {
        showStatus('error', '❌ Lỗi khi tra cứu: ' + error.message);
        searchResult.style.display = 'none';
        document.getElementById('consultBtn').style.display = 'none';
    } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = '🔍 Tra cứu thông tin';
    }
});

// Health consultation functionality with MQTT
document.getElementById('consultBtn').addEventListener('click', function() {
    const consultBtn = document.getElementById('consultBtn');
    const resultId = document.getElementById('resultId').textContent;
    
    if (!resultId) {
        showStatus('error', '❌ Không có dữ liệu để tư vấn');
        return;
    }
    
    consultBtn.disabled = true;
    consultBtn.textContent = '⏳ Đang gửi dữ liệu tư vấn...';
    showStatus('loading', 'Đang gửi dữ liệu tư vấn sức khỏe...');
    
    // Collect health data without type and timestamp
    const healthData = {
        id: resultId,
        heartRate: parseInt(document.getElementById('heartRate').textContent.replace(' bpm', '').replace('--', '') || '0'),
        breathRate: parseInt(document.getElementById('breathRate').textContent.replace(' rpm', '').replace('--', '') || '0'),
        height: parseFloat(document.getElementById('displayHeight').textContent.replace(' cm', '').replace('--', '') || '0'),
        weight: parseFloat(document.getElementById('displayWeight').textContent.replace(' kg', '').replace('--', '') || '0'),
        gender: document.getElementById('displayGender').textContent.replace('--', '') || '',
        age: parseInt(document.getElementById('displayAge').textContent.replace(' tuổi', '').replace('--', '') || '0'),
        bmi: parseFloat(document.getElementById('displayBMI').textContent.replace('--', '') || '0')
    };
    
    // Validate data
    if (!healthData.heartRate || !healthData.breathRate || !healthData.height || 
        !healthData.weight || !healthData.gender || !healthData.age || !healthData.bmi) {
        showStatus('error', '❌ Dữ liệu không đầy đủ để tư vấn');
        console.error('Invalid data:', healthData);
        consultBtn.disabled = false;
        consultBtn.textContent = '🩺 Tư vấn sức khỏe';
        return;
    }
    
    // Convert to JSON
    const payload = JSON.stringify(healthData);
    console.log('MQTT Payload:', payload);
    
    // Send to MQTT
    if (client && client.isConnected()) {
        try {
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = MQTT_TOPIC;
            client.send(message);
            console.log('MQTT Message Sent:', payload);
            showStatus('success', `✅ Đã gửi dữ liệu tư vấn cho ID: ${resultId} qua MQTT`);
            setTimeout(() => hideStatus(), 5000);
        } catch (error) {
            console.error('MQTT Send Error:', error);
            showStatus('error', '❌ Lỗi khi gửi dữ liệu MQTT: ' + error.message);
        }
    } else {
        console.error('MQTT Client not connected');
        showStatus('error', '❌ Không có kết nối MQTT. Vui lòng kiểm tra lại.');
    }
    
    // Gửi dữ liệu đến Google Apps Script với type
    const scriptData = {
        ...healthData,
        type: 'health_consultation'
    };
    
    fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(scriptData)
    })
    .then(response => response.text())
    .then(result => {
        console.log('Google Script Response:', result);
    })
    .catch(error => {
        console.error('Google Script Error:', error);
    })
    .finally(() => {
        consultBtn.disabled = false;
        consultBtn.textContent = '🩺 Tư vấn sức khỏe';
    });
});

// Allow Enter key to trigger search
document.getElementById('searchId').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('searchBtn').click();
    }
});

function showStatus(type, message) {
    const status = document.getElementById('status');
    status.className = `status ${type}`;
    status.textContent = message;
    status.style.display = 'block';
}

function hideStatus() {
    const status = document.getElementById('status');
    status.style.display = 'none';
}

// Auto-calculate and show BMI preview
document.getElementById('weight').addEventListener('input', updateBMIPreview);
document.getElementById('height').addEventListener('input', updateBMIPreview);

function updateBMIPreview() {
    const weight = parseFloat(document.getElementById('weight').value);
    const height = parseFloat(document.getElementById('height').value);
    
    if (weight > 0 && height > 0) {
        const bmi = (weight / Math.pow(height / 100, 2)).toFixed(1);
        let category = '';
        
        if (bmi < 18.5) category = '(Thiếu cân)';
        else if (bmi < 25) category = '(Bình thường)';
        else if (bmi < 30) category = '(Thừa cân)';
        else category = '(Béo phì)';
        
        document.getElementById('submitBtn').textContent = `💾 Lưu thông tin (BMI: ${bmi} ${category})`;
    } else {
        document.getElementById('submitBtn').textContent = '💾 Lưu thông tin cá nhân';
    }
}
</script>
